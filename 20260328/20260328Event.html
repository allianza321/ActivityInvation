<!DOCTYPE html>
<html> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3/28 保戶講座資訊轉發</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f4f7f6; }
        .card { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 85%; position: relative; }
        h2 { color: #003777; margin-bottom: 0.5rem; font-size: 1.4rem; }
        .event-title { color: #E67E22; font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem; }
        .info { color: #666; font-size: 0.95rem; margin-bottom: 1.5rem; }
        .btn-send { padding: 16px 40px; font-size: 1.1rem; background: linear-gradient(135deg, #0056b3 0%, #003777 100%); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(0,55,119,0.3); transition: 0.3s; }
        .version-tag { position: absolute; bottom: 10px; left: 15px; font-size: 10px; color: #e0e0e0; }
    </style>
</head>
<body>
    <div class="card">
        <h2>安聯人壽保戶講座</h2>
        <div class="event-title">2026年十二星座開運解析</div>
        <div class="info">宏國通訊處 2026/3/28(六)</div>
        <button class="btn-send" onclick="sendActivityFlex()">點此選擇好友發送邀請</button>
        <div class="version-tag">Ver. 13.0</div>
    </div>

    <script>
        const liffId = "2009178037-6FFsbvG7";
        const gasUrl = "https://script.google.com/macros/s/AKfycbwb92t1vnrncidzJ9HHbBJEGjC0hJaQR3Vt2UD8KvPPsAjsZP_ApkMQeJdlJeAitBRCig/exec";
        
        let userName = "未知使用者";
        let userId = "無ID";

        async function initLiff() {
            try {
                await liff.init({ liffId: liffId });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    userName = profile.displayName;
                    userId = profile.userId;

                    const urlParams = new URLSearchParams(window.location.search);
                    const targetAction = urlParams.get('target');
                    
                    if (targetAction) {
                        // 若網址帶有跳轉指令，先紀錄動作再跳轉
                        await logToGAS(`點擊-${targetAction}`);
                        performRedirect(targetAction);
                    } else {
                        // 初次進入頁面
                        logToGAS("進入網頁");
                    }
                } else {
                    liff.login();
                }
            } catch (err) { console.error("LIFF 初始化失敗", err); }
        }

        // 統一處理紀錄後的跳轉路徑
        function performRedirect(target) {
            const calendarUrl = "https://www.google.com/calendar/render?action=TEMPLATE&text=" + encodeURIComponent("【安聯人壽】2026年十二星座開運解析") + "&dates=20260328T010000Z/20260328T040000Z" + "&location=" + encodeURIComponent("台北市信義區基隆路二段51號10樓之二(宏國通訊處)");
            const mapUrl = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent("安聯人壽 宏國通訊處");
            const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSfwNIB1dN8B1A-BIqAjxtzlIO4fUP_LAs-6_29t5TPI5Fpndg/viewform";
            const detailImg = "https://github.com/allianza321/ActivityInvation/blob/allianza321-Activity/20260328/20260328%E4%BF%9D%E6%88%B6%E8%AC%9B%E5%BA%A7%E6%B4%BB%E5%8B%95.JPG?raw=true";

            if (target === "calendar") window.location.href = calendarUrl;
            else if (target === "map") window.location.href = mapUrl;
            else if (target === "apply") window.location.href = formUrl;
            else if (target === "image") window.location.href = detailImg;
        }

        async function logToGAS(actionType) {
            const finalUrl = `${gasUrl}?userId=${encodeURIComponent(userId)}&userName=${encodeURIComponent(userName)}&action=${encodeURIComponent(actionType)}`;
            return fetch(finalUrl, { mode: 'no-cors' });
        }

        async function sendActivityFlex() {
            const liffUrl = `https://liff.line.me/${liffId}`;

            if (liff.isApiAvailable('shareTargetPicker')) {
                try {
                    const result = await liff.shareTargetPicker([{
                        "type": "flex",
                        "altText": "您收到一份來自 宏國通訊處 的活動熱情邀約！",
                        "contents": {
                            "type": "bubble",
                            "hero": { 
                                "type": "image", 
                                "url": "https://github.com/allianza321/ActivityInvation/blob/allianza321-Activity/20260328/20260328_TuYuPing_header2.JPG?raw=true", 
                                "size": "full", "aspectRatio": "20:13", "aspectMode": "cover",
                                "action": { "type": "uri", "uri": `${liffUrl}?target=image` } 
                            },
                            "body": {
                                "type": "box", "layout": "vertical", "contents": [
                                    { "type": "text", "text": "安聯人壽保戶講座", "weight": "bold", "size": "xl" },
                                    { "type": "text", "text": "2026年十二星座開運解析", "size": "md", "color": "#E67E22", "weight": "bold", "margin": "sm" },
                                    { "type": "box", "layout": "vertical", "margin": "xl", "spacing": "lg", "contents": [
                                        { 
                                            "type": "box", "layout": "baseline", "spacing": "sm", 
                                            "action": { "type": "uri", "uri": `${liffUrl}?target=calendar` }, 
                                            "contents": [ 
                                                { "type": "text", "text": "時間", "color": "#aaaaaa", "size": "sm", "flex": 1 }, 
                                                { "type": "text", "text": "2026/3/28(六) 09:00 - 12:00", "wrap": true, "color": "#0056b3", "size": "sm", "flex": 5, "decoration": "underline" } 
                                            ] 
                                        },
                                        { 
                                            "type": "box", "layout": "baseline", "spacing": "sm", 
                                            "action": { "type": "uri", "uri": `${liffUrl}?target=map` }, 
                                            "contents": [ 
                                                { "type": "text", "text": "地點", "color": "#aaaaaa", "size": "sm", "flex": 1 }, 
                                                { "type": "text", "text": "台北市信義區基隆路二段51號10樓之二(宏國通訊處)", "wrap": true, "color": "#0056b3", "size": "sm", "flex": 5, "decoration": "underline" } 
                                            ] 
                                        }
                                    ]}
                                ]
                            },
                            "footer": { 
                                "type": "box", "layout": "vertical", "spacing": "sm", "contents": [ 
                                    { "type": "button", "style": "link", "height": "sm", "action": { "type": "uri", "label": "即刻報名", "uri": `${liffUrl}?target=apply` } }, 
                                    { "type": "button", "style": "link", "height": "sm", "action": { "type": "uri", "label": "分享好友", "uri": liffUrl } } 
                                ] 
                            }
                        }
                    }]);
                    if (result) {
                        await logToGAS("分享成功"); 
                        liff.closeWindow();
                    }
                } catch (error) { console.error(error); }
            }
        }
        initLiff();
    </script>
</body>
</html>
