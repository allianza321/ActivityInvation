async function sendActivityFlex() {
    const urlParams = new URLSearchParams(window.location.search);
    const referrer = urlParams.get('from') || 'General';

    // 建立 Google 行事曆連結 (包含前一天提醒的設定)
    // 時間格式：20260328T010000Z (UTC時間，台灣時間09:00為UTC 01:00)
    const calendarUrl = "https://www.google.com/calendar/render?action=TEMPLATE" +
        "&text=" + encodeURIComponent("【安聯人壽保戶講座】2026年十二星座開運解析") +
        "&dates=20260328T010000Z/20260328T040000Z" + 
        "&details=" + encodeURIComponent("歡迎參加宏國通訊處舉辦的星座開運講座！\n地點：台北市信義區基隆路二段51號10樓之二") +
        "&location=" + encodeURIComponent("台北市信義區基隆路二段51號10樓之二") +
        "&trp=true&sprop=website:https://liff.line.me/" + liffId;

    if (liff.isApiAvailable('shareTargetPicker')) {
        try {
            await liff.shareTargetPicker([
                {
                    "type": "flex",
                    "altText": "您收到一份來自 宏國通訊處 的活動熱情邀約！",
                    "contents": {
                        "type": "bubble",
                        "hero": {
                            "type": "image",
                            "url": "https://github.com/allianza321/ActivityInvation/blob/allianza321-Activity/20260328/20260328_TuYuPing_header.JPG?raw=true",
                            "size": "full", "aspectRatio": "20:13", "aspectMode": "cover"
                        },
                        "body": {
                            "type": "box", "layout": "vertical", "contents": [
                                { "type": "text", "text": "安聯人壽保戶講座", "weight": "bold", "size": "xl" },
                                { "type": "text", "text": "2026年十二星座開運解析", "size": "md", "color": "#E67E22", "weight": "bold", "margin": "sm" },
                                { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                                    { 
                                        "type": "box", "layout": "baseline", "spacing": "sm", 
                                        "action": { "type": "uri", "label": "開啟導航", "uri": "https://www.google.com/maps/search/?api=1&query=安聯人壽+宏國通訊處&query_place_id=ChIJIaKZTgCrQjQRkXFZpAmMprE" },
                                        "contents": [
                                            { "type": "text", "text": "地點", "color": "#aaaaaa", "size": "sm", "flex": 1 },
                                            { "type": "text", "text": "台北市信義區基隆路二段51號10樓之二", "wrap": true, "color": "#0056b3", "size": "sm", "flex": 5, "decoration": "underline" }
                                        ]
                                    },
                                    { 
                                        "type": "box", "layout": "baseline", "spacing": "sm", 
                                        "action": { "type": "uri", "label": "加入行事曆", "uri": calendarUrl },
                                        "contents": [
                                            { "type": "text", "text": "時間", "color": "#aaaaaa", "size": "sm", "flex": 1 },
                                            { "type": "text", "text": "2026/3/28(六) 09:00 - 12:00", "wrap": true, "color": "#0056b3", "size": "sm", "flex": 5, "decoration": "underline" }
                                        ]
                                    }
                                ]}
                            ]
                        },
                        "footer": {
                            "type": "box", "layout": "vertical", "spacing": "sm", "contents": [
                                { "type": "button", "style": "link", "height": "sm", "action": { "type": "uri", "label": "即刻報名", "uri": "https://docs.google.com/forms/d/e/1FAIpQLSfwNIB1dN8B1A-BIqAjxtzlIO4fUP_LAs-6_29t5TPI5Fpndg/viewform" } },
                                { "type": "button", "style": "link", "height": "sm", "action": { "type": "uri", "label": "分享好友", "uri": `https://liff.line.me/${liffId}?from=${referrer}` } }
                            ]
                        }
                    }
                }
            ]);
            liff.closeWindow();
        } catch (error) {
            console.error(error);
        }
    }
}
